<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="imgs/logo.png">
    <link rel="stylesheet" href="styleBoss.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Boss</title>
</head>

<body>
    <nav class="navBarContainer">
        <div id="buttonContainer">
            <button id="btnProjects">Proyectos</button>
            <button id="btnAddUser">Agregar Usuario</button>
            <button id="btnConsultUsers">Consultar Usuarios</button>
            <button id="btnLogOut">Cerrar sesión</button>
        </div>
        <p id="message"></p>
    </nav>

    <div id="windowQsOverlay">
        <div id="windowQs">
            <p>¿Quieres cerrar tu sesión?</p>
            <button id="closeSesionSi">Si</button>
            <button id="closeSesionNo">No</button>
        </div>
    </div>

    <div id="usersTableOverLay">
        <div id="usersTableContainer">
            <p id="closeI">I</p>
            <p id="closeJ">J</p>
            <button id="btnEmployees">Empleados</button>
            <button id="btnBosses">Jefes</button>
            <button id="getByID">ID</button>
            <input type="text" id="inputGetById" placeholder="ID">
            <button id="sendID">Ok</button><br>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Área</th>
                        <th>Posición</th>
                        <th>Rol</th>
                        <th>Fecha de contrato</th>
                        <th>Usuario</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="windowPutOverLay">
        <div id="containterPut">
            <p>Editar usuario</p>
            <form id="editUserForm">
                <input type="text" id="name" name="name" placeholder="Name">
                <input type="text" id="department" name="department" placeholder="Department">
                <input type="text" id="position" name="position" placeholder="Posición">

                <button type="submit">Confirmar cambios</button>
            </form>
        </div>
    </div>

    <div id="addUserOverlay" style="display: none;">
        <div id="addUserContainer">
            <p>Agregar nuevo usuario</p>
            <form id="addUserForm">
                <input type="text" id="newName" name="newName" placeholder="Nombre" required>
                <input type="text" id="newDepartment" name="newDepartment" placeholder="Área" required>
                <input type="text" id="newPosition" name="newPosition" placeholder="Posición" required>
                <input type="text" id="newRole" name="newRole" placeholder="Rol (boss/employee)" required>
                <input type="date" id="newContractDate" name="newContractDate" required>
                <input type="text" id="newUser" name="newUser" placeholder="Usuario" required>
                <button type="submit" id="addUserBtn">Crear Usuario</button>
            </form>
        </div>
    </div>


    <!-- Overlay de Proyectos -->
    <div id="projectsOverlay" style="display: none;">
        <div id="projectsContainer">
            <h2>Gestión de Proyectos</h2>
            <button id="btnGetProjects">Consultar Proyectos</button>
            <button id="btnCreateProject">Crear. Proyecto</button>
            <button id="btnSearchProject">Buscar Proyecto por ID</button>

            <!-- Tabla de proyectos -->
            <div id="projectsTableContainer" style="display: none;">
                <table id="projectsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Jefe</th>
                            <th>ID del Jefe</th>
                            <th>Estado</th>
                            <th>Miembros</th>

                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Formulario para crear proyectos -->
            <div id="container2Crear" display="none">
                <form id="projectForm">
                    <input type="text" id="projName" name="projName" placeholder="Nombre del Proyecto" required>
                    <input type="text" id="projOwner" name="projOwner" placeholder="Responsable">
                    <input type="text" id="projidOwner" name="projidOwner" placeholder="ID responsable">
                    <input type="text" id="projStatus" name="projStatus" placeholder="Estado">
                    <input type="text" id="projTeam" name="projTeam" placeholder="Miembros del proyecto">
                    <button type="submit">Grabar Proyecto</button>
                </form>
            </div>

            <div id="searchProjectModal" style="display: none;">
                <h2>Buscar Proyecto por ID</h2>
                <form id="searchForm">
                    <label for="searchProjectId">ID del Proyecto:</label>
                    <input type="text" id="searchProjectId" required><br><br>
                    <button type="submit">Buscar</button>
                </form>
                <pre id="searchResult"></pre>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Panel de Control - Análisis de Tareas</h1>

        <div class="card">
            <h2>Acciones</h2>
            <button onclick="ejecutarAnalisis()">Ejecutar Análisis Completo</button>
            <button onclick="cargarDashboard()">Actualizar Dashboard</button>
            <button onclick="detectarProblemas()">Detectar Problemas</button>
            <div id="mensaje" style="margin-top: 10px;"></div>
        </div>

        <div class="card">
            <h2>Dashboard</h2>
            <div id="dashboard-content">
                <p class="loading">Cargando dashboard...</p>
            </div>
        </div>

        <!-- Nueva card para el pie chart de estados -->
        <div class="card">
            <h2>Distribución de Estados de Tareas</h2>
            <div class="chart-container">
                <canvas id="task-chart-canvas"></canvas>
                <canvas id="estadosChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Top 5 Empleados</h2>
            <div id="top-empleados">
                <p class="loading">Cargando...</p>
            </div>
        </div>

        <div class="card">
            <h2>Empleados con Problemas</h2>
            <div id="empleados-problema">
                <p class="loading">Cargando...</p>
            </div>
        </div>

        <div class="card">
            <h2>Buscar Empleado</h2>
            <input type="number" id="empleado-id" placeholder="ID del empleado">
            <button onclick="buscarEmpleado()">Buscar</button>
            <div id="empleado-info" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8003/analisis';

        // Variable global para el gráfico
        let estadosChart = null;

        // Cargar dashboard al iniciar
        window.onload = () => {
            cargarDashboard();
            cargarDistribucionEstados()
        };

        async function ejecutarAnalisis() {
            mostrarMensaje('Ejecutando análisis... esto puede tomar varios minutos', 'loading');

            try {
                const response = await fetch(`${API_BASE}/ejecutar`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    mostrarMensaje('Análisis completado exitosamente', 'success');
                    setTimeout(cargarDashboard, 2000);
                } else {
                    mostrarMensaje(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                mostrarMensaje(`Error: ${error.message}`, 'error');
            }
        }

        async function cargarDashboard() {
            try {
                console.log('Cargando dashboard...');
                const response = await fetch(`${API_BASE}/dashboard`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                console.log('Respuesta cruda:', text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('Error al parsear JSON:', e);
                    throw new Error('Respuesta del servidor no es JSON válido');
                }

                console.log('Datos parseados:', data);

                if (data.success) {
                    console.log('Mostrando dashboard con datos:', data.data);
                    mostrarDashboard(data.data);
                    mostrarTopEmpleados(data.data.topEmpleados || []);
                    mostrarEmpleadosProblema(data.data.empleadosProblema || []);
                    cargarDistribucionEstados();

                } else {
                    mostrarMensaje('Error al cargar dashboard: ' + (data.message || 'Error desconocido'), 'error');
                }
            } catch (error) {
                console.error('Error completo:', error);
                mostrarMensaje(`Error: ${error.message}`, 'error');
            }
        }

        function mostrarDashboard(data) {
            const stats = data.estadisticas;
            document.getElementById('dashboard-content').innerHTML = `
                <div class="dashboard-grid">
                    <div class="stat-box">
                        <div class="stat-value">${stats.total_empleados}</div>
                        <div class="stat-label">Empleados</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.total_tareas_unicas}</div>
                        <div class="stat-label">Tareas Únicas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.calificacion_promedio}/5.0</div>
                        <div class="stat-label">Calificación Promedio</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.porcentaje_completado}%</div>
                        <div class="stat-label">Completitud</div>
                    </div>
                </div>
            `;
        }
        async function cargarDistribucionEstados() {
            try {
                const response = await fetch(`${API_BASE}/distribucion-estados`);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Transformar los datos al formato requerido
                    const estadosData = {
                        'asignado': parseInt(result.data.total_asignadas),
                        'entregado': parseInt(result.data.total_entregadas),
                        'tardio': parseInt(result.data.total_tardias)
                    };

                    // Datos de porcentajes para usar en tooltips
                    const porcentajes = {
                        'asignado': result.data.porcentaje_asignadas,
                        'entregado': result.data.porcentaje_entregadas,
                        'tardio': result.data.porcentaje_tardias
                    };

                    // Actualizar el gráfico circular con los datos y porcentajes
                    actualizarChartEstados(estadosData, porcentajes);
                } else {
                    console.error('Error en la respuesta:', result.message);
                }
            } catch (error) {
                console.error('Error al cargar distribución de estados:', error);
            }
        }

        function actualizarChartEstados(estadosData, porcentajes) {
            const ctx = document.getElementById('estadosChart').getContext('2d');

            // Preparar los datos para el gráfico
            const labels = [];
            const data = [];
            const backgroundColor = [];
            const borderColor = [];

            // Colores para cada estado
            const colores = {
                asignado: '#4D77CF', // Azul claro
                entregado: '#28a745', // Verde
                tardio: '#dc3545'     // Rojo
            };

            // Procesar los datos
            for (const [estado, cantidad] of Object.entries(estadosData)) {
                // Convertir 'asignado' a 'Asignado', etc.
                labels.push(estado.charAt(0).toUpperCase() + estado.slice(1));
                data.push(cantidad);
                backgroundColor.push(colores[estado] || '#007bff');
                borderColor.push('#fff');
            }

            // Si ya existe un gráfico, destruirlo
            if (estadosChart) {
                estadosChart.destroy();
            }

            // Crear el nuevo gráfico
            estadosChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Estados de Tareas',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    // Obtener el nombre del estado en minúsculas para acceder a porcentajes
                                    const estadoKey = context.label.toLowerCase();
                                    // Obtener el valor numérico de tareas
                                    const cantidad = context.raw;
                                    // Obtener el porcentaje correspondiente
                                    const porcentaje = porcentajes[estadoKey];

                                    // Formato: "Estado: cantidad (porcentaje%)"
                                    return `${context.label}: ${cantidad} (${porcentaje}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function mostrarTopEmpleados(empleados) {
            let html = '<table><tr><th>Ranking</th><th>Empleado ID</th><th>Score</th><th>Calificación</th><th>% Completado</th></tr>';

            empleados.forEach(emp => {
                const score = emp.score_total !== null && emp.score_total !== undefined
                    ? emp.score_total.toFixed(2)
                    : 'N/A';
                const calificacion = emp.calificacion !== null && emp.calificacion !== undefined
                    ? emp.calificacion.toFixed(2)
                    : 'N/A';

                html += `<tr>
                    <td>#${emp.ranking}</td>
                    <td>${emp.empleado_id}</td>
                    <td>${score}</td>
                    <td>${calificacion}/5.0</td>
                    <td>${emp.porcentaje_completado || 0}%</td>
                </tr>`;
            });

            html += '</table>';
            document.getElementById('top-empleados').innerHTML = html;
        }

        function mostrarEmpleadosProblema(empleados) {
            if (!empleados || empleados.length === 0) {
                document.getElementById('empleados-problema').innerHTML = '<p>No se detectaron empleados con problemas</p>';
                return;
            }

            let html = '<table><tr><th>Empleado ID</th><th>Tareas Tardías</th><th>% Completadas</th><th>Calificación</th></tr>';

            empleados.forEach(emp => {
                // Usar el nombre correcto del campo
                const calificacion = emp.calificacion_general_promedio !== null && emp.calificacion_general_promedio !== undefined
                    ? Number(emp.calificacion_general_promedio).toFixed(2)
                    : 'N/A';

                html += `<tr>
                    <td>${emp.empleado_id}</td>
                    <td>${emp.tareas_tardias || 0}</td>
                    <td>${emp.porcentaje_completadas || 0}%</td>
                    <td>${calificacion}</td>
                </tr>`;
            });

            html += '</table>';
            document.getElementById('empleados-problema').innerHTML = html;
        }

        async function buscarEmpleado() {
            const empleadoId = document.getElementById('empleado-id').value;
            if (!empleadoId) {
                mostrarMensaje('Por favor ingresa un ID de empleado', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/empleado/${empleadoId}`);
                const data = await response.json();

                if (data.success) {
                    mostrarInfoEmpleado(data.data);
                } else {
                    mostrarMensaje('Error al buscar empleado', 'error');
                }
            } catch (error) {
                mostrarMensaje(`Error: ${error.message}`, 'error');
            }
        }

        function mostrarInfoEmpleado(data) {
            const { rendimiento, calidad, ranking } = data;

            if (!rendimiento) {
                document.getElementById('empleado-info').innerHTML = '<p>Empleado no encontrado</p>';
                return;
            }

            const html = `
                <h3>Información del Empleado ${rendimiento.empleado_id}</h3>
                <div class="dashboard-grid">
                    <div class="stat-box">
                        <div class="stat-value">${rendimiento.tareas_completadas || 0}</div>
                        <div class="stat-label">Tareas Completadas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${formatNumber(rendimiento.porcentaje_completadas)}%</div>
                        <div class="stat-label">% Completadas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${formatNumber(rendimiento.calificacion_promedio)}</div>
                        <div class="stat-label">Calificación</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">#${ranking ? ranking.ranking : 'N/A'}</div>
                        <div class="stat-label">Ranking</div>
                    </div>
                </div>
            `;

            document.getElementById('empleado-info').innerHTML = html;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return Number(num).toFixed(2);
        }

        async function detectarProblemas() {
            try {
                const response = await fetch(`${API_BASE}/problemas`);
                const data = await response.json();

                if (data.success) {
                    mostrarProblemas(data.data);
                } else {
                    mostrarMensaje('Error al detectar problemas', 'error');
                }
            } catch (error) {
                mostrarMensaje(`Error: ${error.message}`, 'error');
            }
        }

        function mostrarProblemas(data) {
            let mensaje = 'Problemas detectados:\n';
            mensaje += `- ${data.altasTasasRetraso.length} empleados con alta tasa de retraso\n`;
            mensaje += `- ${data.bajasCalificaciones.length} empleados con baja calificación\n`;
            mensaje += `- ${data.sobrecarga.length} empleados con sobrecarga de trabajo`;

            alert(mensaje);
        }

        function mostrarMensaje(mensaje, tipo) {
            const div = document.getElementById('mensaje');
            div.className = tipo;
            div.textContent = mensaje;

            if (tipo !== 'loading') {
                setTimeout(() => {
                    div.textContent = '';
                    div.className = '';
                }, 5000);
            }
        }
    </script>

    <script>

        async function getUsersByRole(role) {
            try {
                const response = await fetch(`http://localhost:8000/users/role/${role}`);
                const data = await response.json();

                if (!data.Ok) {
                    throw new Error(data.error || 'Error al obtener los datos.');
                }

                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';

                data.data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.department}</td>
                        <td>${user.position}</td>
                        <td>${user.role}</td>
                        <td>${new Date(user.contract_date).toLocaleDateString('es-ES')}</td>
                        <td>${user.user}</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('usersTable').style.display = 'table';
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function getUserByID(id) {
            try {
                let user = await fetch(`http://localhost:8000/users/${id}`);
                user = await user.json();

                if (!user || !user.id) {
                    throw new Error('Error al obtener los datos.');
                }

                //Encabezado
                const head = document.querySelector('#usersTable thead');
                head.innerHTML = '';

                let rowH = document.createElement('tr');

                rowH.innerHTML = `
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Área</th>
                    <th>Posición</th>
                    <th>Rol</th>
                    <th>Fecha de contrato</th>
                    <th>Usuario</th> 
                    <th>Modificar<br>info</th>
                `;
                head.appendChild(rowH)

                //Cuerpo
                const table = document.querySelector('#usersTable tbody');
                table.innerHTML = '';

                let rowB = document.createElement('tr');

                rowB.innerHTML = '';
                rowB.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.department}</td>
                    <td>${user.position}</td>
                    <td>${user.role}</td>
                    <td>${new Date(user.contract_date).toLocaleDateString('es-ES')}</td>
                    <td>${user.user}</td>
                    <td><img src="/imgs/62079ec826ab99000460a34b.png" alt="btnPut" data-user-id="${user.id}" class="btnPut"></td>
                `
                table.appendChild(rowB)

                document.getElementById('usersTable').style.display = 'table';
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        const clean = (show = [], hide = []) => {
            show.forEach(id => document.getElementById(id).style.display = 'flex');
            hide.forEach(id => document.getElementById(id).style.display = 'none');
        };

        document.getElementById('btnLogOut').addEventListener('click', () => {
            clean(['windowQsOverlay'], ['usersTableContainer']);
        });

        document.getElementById('closeSesionNo').addEventListener('click', () => {
            document.getElementById('windowQsOverlay').style.display = 'none';
        });

        document.getElementById('closeSesionSi').addEventListener('click', () => {
            sessionStorage.clear();
            window.location.href = 'login.html';
        });

        document.getElementById('btnConsultUsers').addEventListener('click', () => {
            clean(['usersTableOverLay', 'usersTableContainer', 'closeJ', 'btnEmployees', 'btnBosses', 'getByID'], ['closeI', 'usersTable', 'inputGetById', 'sendID']);
        });

        document.getElementById('getByID').addEventListener('click', () => {
            clean(['inputGetById', 'sendID', 'closeI'], ['btnEmployees', 'btnBosses', 'getByID', 'closeJ']);
        });

        document.getElementById('sendID').addEventListener('click', () => {
            const id = document.getElementById('inputGetById').value.trim();
            document.getElementById('inputGetById').value = '';
            if (id) {
                getUserByID(id);
            } else {
                alert('Ingresa un ID válido.');
            }
        });

        document.getElementById('btnBosses').addEventListener('click', () => {
            getUsersByRole('boss');
            clean(['closeI'], ['btnEmployees', 'btnBosses', 'closeJ', 'inputGetById', 'sendID', 'getByID']);
        });

        document.getElementById('btnEmployees').addEventListener('click', () => {
            getUsersByRole('employee');
            clean(['closeI'], ['btnEmployees', 'btnBosses', 'closeJ', 'inputGetById', 'sendID', 'getByID']);
        });


        document.getElementById('closeJ').addEventListener('click', () => {
            document.getElementById('usersTableContainer').style.display = 'none';
            document.getElementById('usersTableOverLay').style.display = 'none';
        });

        document.getElementById('closeI').addEventListener('click', () => {
            clean(['btnEmployees', 'btnBosses', 'getByID', 'closeJ'], ['usersTable', 'closeI', 'inputGetById', 'sendID']);
        });

        document.addEventListener('click', async (event) => {
            if (event.target.classList.contains('btnPut')) {
                let id = event.target.getAttribute('data-user-id');


                try {
                    let user = await fetch(`http://localhost:8000/users/${id}`);
                    user = await user.json();

                    if (!user.id) throw new Error("Usuario no encontrado.");

                    // Llenar los campos con los valores actuales
                    document.getElementById("name").value = user.name;
                    document.getElementById("department").value = user.department;
                    document.getElementById("position").value = user.position;

                    // Guardar el ID en el formulario para usarlo en la actualización
                    document.getElementById("editUserForm").setAttribute("data-user-id", id);

                    // Mostrar el modal
                    document.getElementById('windowPutOverLay').style.display = 'flex';
                    document.querySelectorAll("#editUserForm input").forEach(input => {
                        input.style.display = 'flex';
                    });

                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }
        });

        document.getElementById("editUserForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            let id = event.target.getAttribute("data-user-id");

            const updatedUser = {
                name: document.getElementById("name").value.trim(),
                department: document.getElementById("department").value.trim(),
                position: document.getElementById("position").value.trim()
            };

            try {
                let response = await fetch(`http://localhost:8000/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUser)
                });

                let result = await response.json();
                if (!result.ok) throw new Error(result.error || "Error al actualizar el usuario.");

                alert("Usuario actualizado correctamente.");

                // Ocultar modal solo si la actualización fue exitosa
                document.getElementById('windowPutOverLay').style.display = 'none';

                // Buscar la fila correspondiente en la tabla y actualizar los valores
                document.querySelectorAll("#usersTable tbody tr").forEach(row => {
                    if (row.children[0].textContent == id) {
                        row.children[1].textContent = updatedUser.name;
                        row.children[2].textContent = updatedUser.department;
                        row.children[3].textContent = updatedUser.position;
                    }
                });

            } catch (error) {
                alert(`Error al actualizar: ${error.message}`);
            }
        });

        document.getElementById("btnAddUser").addEventListener("click", () => {
            document.getElementById("addUserOverlay").style.display = "flex";
        });


        document.getElementById("btnAddUser").addEventListener("click", () => {
            document.getElementById("addProjectOverlay").style.display = "flex";
        });

        document.getElementById("addUserOverlay").addEventListener("click", (event) => {
            if (event.target.id === "addUserOverlay") {
                document.getElementById("addUserOverlay").style.display = "none";
            }
        });

        document.getElementById("addUserForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const newUser = {
                name: document.getElementById("newName").value.trim(),
                department: document.getElementById("newDepartment").value.trim(),
                position: document.getElementById("newPosition").value.trim(),
                role: document.getElementById("newRole").value.trim().toLowerCase(),
                contract_date: document.getElementById("newContractDate").value,
                user: document.getElementById("newUser").value.trim()
            };

            // Validación del rol
            if (newUser.role !== "boss" && newUser.role !== "employee") {
                alert("Error: El rol debe ser 'boss' o 'employee'.");
                return;
            }

            try {
                let response = await fetch("http://localhost:8000/user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newUser)
                });

                let result = await response.json();
                if (!result.ok) throw new Error(result.error || "Error al agregar usuario.");

                alert("✅ Usuario agregado correctamente.");

                // Ocultar modal y limpiar formulario
                document.getElementById("addUserOverlay").style.display = "none";
                document.getElementById("addUserForm").reset();
            } catch (error) {
                alert(`❌ Error: ${error.message}`);
            }
        });


        window.addEventListener('load', () => {
            document.getElementById('windowQsOverlay').style.display = 'none';
            document.getElementById('usersTableContainer').style.display = 'none';
            const userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
            if (!userInfo || userInfo.role !== 'boss') {
                alert('Acceso denegado. Redirigiendo al login...');
                window.location.href = 'login.html';
            } else {
                document.getElementById('message').textContent = `Bienvenid@ ${userInfo.name}`;
            }
        });

        document.getElementById("windowPutOverLay").addEventListener("click", (event) => {
            if (event.target.id === "windowPutOverLay") {
                document.getElementById("windowPutOverLay").style.display = "none";
            }
        });

        // Función auxiliar para mostrar u ocultar elementos
        function toggleVisibility(id, show) {
            document.getElementById(id).classList.toggle("hidden", !show);
        }

        document.getElementById("btnProjects").addEventListener("click", () => {
            const element = document.getElementById("projectsOverlay");
            if (element.style.display === "flex") {
                element.style.display = "none";
            } else {
                element.style.display = "flex"
            }
        });

        // Cerrar el overlay de proyectos

        document.getElementById("projectsOverlay").addEventListener("click", (e) => {
            if (e.target.id === "projectsOverlay") {
                document.getElementById("projectsOverlay").style.display = "none";
                document.getElementById("projectsTableContainer").style.display = "none";
            }
        });

        document.getElementById("btnGetProjects").addEventListener("click", async () => {
            try {
                const res = await fetch("http://localhost:8001/projects");
                if (!res.ok) throw new Error("Error al obtener proyectos.");
                const data = await res.json();

                const tbody = document.querySelector("#projectsTable tbody");
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5">No hay proyectos disponibles.</td></tr>`;
                } else {
                    data.forEach(project => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${project.project_id}</td>
                            <td>${project.project_name}</td>
                            <td>${project.boss_name}</td>
                            <td>${project.boss_id}</td>
                            <td>${project.status}</td>
                            <td>${project.team_members}</td>

                        `;
                        tbody.appendChild(row);
                    });
                }
                const element = document.getElementById("projectsTableContainer");
                if (element.style.display === "flex") {
                    element.style.display = "none";
                } else { element.style.display = "flex"; }
            } catch (error) {
                alert(error.message);
            }
        });


        document.getElementById("projectForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const newProject = {
                project_name: document.getElementById("projName").value.trim(),
                boss_name: document.getElementById("projOwner").value.trim(),
                boss_id: document.getElementById("projidOwner").value.trim(),
                status: document.getElementById("projStatus").value.trim(),
                team_members: document.getElementById("projTeam").value.trim().split(",").map(item => item.trim())

            };

            try {
                console.log(JSON.stringify(newProject));
                const res = await fetch("http://localhost:8001/projects", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newProject)
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error);
                alert("Proyecto creado correctamente.");
                document.getElementById("projectForm").reset();
                document.getElementById("projectForm").style.display = "flex";
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        document.getElementById("btnCreateProject")?.addEventListener("click", () => {
            const form = document.getElementById("container2Crear");
            if (form.style.display === "flex") {
                form.style.display = "none"
            } else {
                form.style.display = "flex"
            }

        });

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("btnSearchProject").addEventListener("click", () => {
                const element = document.getElementById("searchProjectModal");
                if (element.style.display === "block") {
                    element.style.display = "none"
                } else {
                    element.style.display = "block"
                }
            });

            document.getElementById("searchForm").addEventListener("submit", async (event) => {
                event.preventDefault();
                const id = document.getElementById("searchProjectId").value;
                try {
                    const response = await fetch(`http://localhost:8001/projects/${id}`);
                    const result = await response.json();
                    document.getElementById("searchResult").textContent = JSON.stringify(result, null, 2);
                } catch (error) {
                    console.error("Error consultando proyecto", error);
                }
            });
        });
    </script>
    <script>
        const allCanvases = document.querySelectorAll('canvas');
        const mainContainer = document.querySelector('.container'); // Selecciona el contenedor principal
        const overlays = [
            'windowQsOverlay',
            'usersTableOverLay',
            'windowPutOverLay',
            'addUserOverlay',
            'projectsOverlay',
            'searchProjectModal'
        ];

        function toggleCanvases() {
            const isAnyOverlayVisible = overlays.some(id => {
                const el = document.getElementById(id);
                return el && (el.style.display === 'flex' || el.style.display === 'block');
            });

            // Aplicar o quitar la clase blur a los canvases y al contenedor
            allCanvases.forEach(canvas => {
                canvas.classList.toggle('blur', isAnyOverlayVisible);
            });
            if (mainContainer) {
                mainContainer.classList.toggle('blur', isAnyOverlayVisible);
            }
        }

        // Añadir event listeners a los botones y overlays
        overlays.forEach(overlayId => {
            const overlay = document.getElementById(overlayId);
            if (overlay) {
                overlay.addEventListener('click', toggleCanvases);
                // Observar cambios en el estilo display
                new MutationObserver(toggleCanvases).observe(overlay, {
                    attributes: true,
                    attributeFilter: ['style']
                });
            }
        });

        // Botones que activan/desactivan overlays
        document.getElementById('btnLogOut').addEventListener('click', toggleCanvases);
        document.getElementById('btnConsultUsers').addEventListener('click', toggleCanvases);
        document.getElementById('btnAddUser').addEventListener('click', toggleCanvases);
        document.getElementById('btnProjects').addEventListener('click', toggleCanvases);
        document.getElementById('btnSearchProject').addEventListener('click', toggleCanvases);
        document.getElementById('closeSesionNo').addEventListener('click', toggleCanvases);
        document.getElementById('closeSesionSi').addEventListener('click', toggleCanvases);
        document.getElementById('closeI').addEventListener('click', toggleCanvases);
        document.getElementById('closeJ').addEventListener('click', toggleCanvases);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_URL = 'http://localhost:8003/assignedT';
        let taskChart;

        // Configuración para alta resolución
        function setupCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            return ctx;
        }

        // Esquema monocromático
        const colorPalette = {
            asignado: 'rgba(100, 149, 237, 0.8)',
            entregado: 'rgba(65, 105, 225, 0.8)',
            tardio: 'rgba(30, 144, 255, 0.8)',
            border: 'rgba(25, 25, 112, 0.8)'
        };

        async function loadTaskData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                let Asignado = 0, Entregado = 0, Tardio = 0;

                data.forEach(entrada => {
                    if (entrada.estado === 'Asignado') Asignado++;
                    if (entrada.estado === 'Entregado') Entregado++;
                    if (entrada.estado === 'Tardio') Tardio++;
                });

                renderTaskChart(Asignado, Entregado, Tardio);

            } catch (error) {
                console.error('Error al obtener datos:', error);
                renderTaskChart(0, 0, 0);
            }
        }

        function renderTaskChart(asignado, entregado, tardio) {
            const canvas = document.getElementById('task-chart-canvas');
            const ctx = setupCanvas(canvas);

            if (taskChart) {
                taskChart.destroy();
            }

            taskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Asignado', 'Entregado', 'Tardío'],
                    datasets: [{
                        label: 'Cantidad de Tareas',
                        data: [asignado, entregado, tardio],
                        backgroundColor: [
                            colorPalette.asignado,
                            colorPalette.entregado,
                            colorPalette.tardio
                        ],
                        borderColor: [
                            colorPalette.border,
                            colorPalette.border,
                            colorPalette.border
                        ],
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: 2,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 10
                            }
                        },
                        tooltip: {
                            bodyFont: {
                                size: 12
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 800
                    }
                }
            });
        }

        // Manejar redimensionamiento
        window.addEventListener('resize', function () {
            if (taskChart) {
                const canvas = document.getElementById('task-chart-canvas');
                setupCanvas(canvas);
                taskChart.resize();
            }
        });

        document.addEventListener('DOMContentLoaded', loadTaskData);
    </script>

    <script>
        // Función para formatear números con punto decimal
        function formatearNumero(numero) {
            return numero.toLocaleString('en-US', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2,
                useGrouping: true
            });
        }

        // URL del endpoint (reemplazar con la real)
        const API_URL2 = 'http://localhost:8003/assignedT';

        // Elementos del DOM
        const valorElement = document.getElementById('rating-value');

        // Estados de visualización
        const styles = {
            loading: 'font-size: 28px; font-weight: 600; color: #999; font-style: italic;',
            error: 'font-size: 28px; font-weight: 600; color: #e74c3c;',
            normal: 'font-size: 28px; font-weight: 600; color: #2b5876;'
        };

        // Función para actualizar estilos
        function setStyle(element, style) {
            element.setAttribute('style', style);
        }

        // Función para obtener y mostrar datos
        async function fetchData() {
            try {
                setStyle(valorElement, styles.loading);
                valorElement.textContent = 'Cargando...';

                const response = await fetch(API_URL2);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                let sum = 0;

                for (let entrada of data) {
                    sum += entrada.calificacion_promedio;
                }

                const valor = data.length > 0 ? sum / data.length : 0;
                const valorFormateado = formatearNumero(valor);

                setStyle(valorElement, styles.normal);
                valorElement.textContent = valorFormateado;

            } catch (error) {
                console.error('Error al obtener datos:', error);
                setStyle(valorElement, styles.error);
                valorElement.textContent = 'Error al cargar';
            }
        }

        // Cargar datos cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>

    </head>

</html>